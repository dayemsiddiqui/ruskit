# Entities

Entities in Ruskit represent the data structures of your application. They are the foundation of your models and define the shape of your database tables.

## Entity Structure

An entity is a Rust struct that represents a database table. It defines:
- The fields and their types
- Validation rules through derive macros
- Serialization/deserialization behavior

## Auto-Generated Entities

Entities are automatically generated from your database schema after running migrations:

```bash
cargo kit migrate        # Run pending migrations and generate entities
cargo kit migrate:fresh # Drop all tables, re-run migrations, and generate entities
```

Each generated entity file includes:
- A warning header about auto-generation
- Instructions for regeneration
- Instructions for modifying the schema
- Table documentation
- Field-level documentation (primary keys, nullable fields)
- Proper type mappings based on the schema

Example of a generated entity:

```rust
//! This file is auto-generated after running database migrations.
//! DO NOT EDIT THIS FILE MANUALLY.
//! 
//! To regenerate this file, run:
//! ```bash
//! cargo kit migrate
//! ```
//! 
//! To modify the schema, create a new migration:
//! ```bash
//! cargo kit make:migration add_field_to_users --model User
//! ```
//! 
//! Then edit the migration file and run:
//! ```bash
//! cargo kit migrate
//! ```

use crate::framework::prelude::*;

/// Represents a record in the `users` table.
/// This struct is automatically generated from the database schema.
#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct User {
    /// Primary key of the record
    #[sqlx(default)]
    pub id: i64,
    pub name: String,
    pub email: String,
    pub created_at: i64,
    pub updated_at: i64,
}
```

## Type Mappings

The entity generator automatically maps SQLite types to Rust types:

| SQLite Type | Rust Type | Notes |
|------------|-----------|-------|
| INTEGER | i64 | Used for IDs, timestamps, and numeric fields |
| REAL | f64 | For floating-point numbers |
| TEXT | String | For text fields |
| BOOLEAN | bool | For boolean values |
| * | String | Default fallback for unknown types |

Nullable fields are automatically wrapped in `Option<T>` unless they are primary keys.

## Best Practices

1. **Schema Changes**:
   - Never edit entity files directly
   - Always create migrations for schema changes
   - Run `cargo kit migrate` to regenerate entities

2. **Field Types**:
   - Primary keys are always non-nullable
   - Use appropriate SQLite types in migrations
   - Consider using TEXT for UUIDs or large numbers

3. **Organization**:
   - Entities are stored in `src/app/entities/`
   - One entity per file
   - Automatically exported through `mod.rs`

4. **Documentation**:
   - Generated documentation explains the table structure
   - Field documentation indicates constraints
   - Comments show how to modify the schema

## Common Patterns

### Creating New Tables

1. Create a new migration:
```bash
cargo kit make:migration create_orders_table --model Order
```

2. Edit the migration file to define your schema
3. Run migrations to generate the entity:
```bash
cargo kit migrate
```

### Adding Fields

1. Create a modification migration:
```bash
cargo kit make:migration add_status_to_orders --model Order
```

2. Edit the migration file to add your field
3. Run migrations to update the entity:
```bash
cargo kit migrate
```

### Relationships

Use descriptive foreign key names in your migrations:

```sql
CREATE TABLE posts (
    id INTEGER PRIMARY KEY,
    author_id INTEGER NOT NULL,  -- Better than just user_id
    category_id INTEGER,         -- Optional relationship
    FOREIGN KEY (author_id) REFERENCES users(id),
    FOREIGN KEY (category_id) REFERENCES categories(id)
);
```

The entity generator will preserve these relationships in the generated code.

## Entity Definition

A basic entity looks like this:

```rust
use serde::{Deserialize, Serialize};
use sqlx::FromRow;
use rustavel_derive::GenerateValidationFields;
use crate::framework::database::model::{Field, ModelValidation};
use validator::ValidationError;

#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct User {
    #[sqlx(default)]
    pub id: i64,
    pub name: String,
    pub email: String,
    pub created_at: i64,
    pub updated_at: i64,
}
```

## Derive Macros

Entities use several important derive macros:

1. `#[derive(Debug, Serialize, Deserialize)]`
   - Enables debugging and JSON serialization/deserialization
   - Required for API responses and database operations

2. `#[derive(FromRow)]`
   - Allows SQLx to map database rows to your entity
   - Automatically converts database types to Rust types

3. `#[derive(GenerateValidationFields)]`
   - Generates validation field definitions
   - Creates the necessary trait implementations for validation
   - Works in conjunction with the `ValidationRules` trait in your model

## Field Attributes

### SQLx Attributes

- `#[sqlx(default)]`: Use default value if field is NULL
- `#[sqlx(rename = "column_name")]`: Map to different column name
- `#[sqlx(type_name = "custom_type")]`: Specify custom SQL type

### Validation Attributes

Validation is handled at the model level through the `ValidationRules` trait. The entity's `GenerateValidationFields` derive macro generates the necessary field definitions.

## Example Entities

### Basic Entity

```rust
#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct Post {
    #[sqlx(default)]
    pub id: i64,
    pub title: String,
    pub content: String,
    pub published: bool,
    pub created_at: i64,
    pub updated_at: i64,
}
```

### Entity with Relationships

```rust
#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct Comment {
    #[sqlx(default)]
    pub id: i64,
    pub post_id: i64,  // Foreign key to posts table
    pub user_id: i64,  // Foreign key to users table
    pub content: String,
    pub created_at: i64,
    pub updated_at: i64,
}
```

### Entity with Optional Fields

```rust
#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct Profile {
    #[sqlx(default)]
    pub id: i64,
    pub user_id: i64,
    pub bio: Option<String>,
    pub website: Option<String>,
    pub avatar_url: Option<String>,
    pub created_at: i64,
    pub updated_at: i64,
}
```

## Common Patterns

### Timestamps

Always include `created_at` and `updated_at` fields:

```rust
#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct User {
    // ... other fields ...
    pub created_at: i64,
    pub updated_at: i64,
}
```

### Foreign Keys

Use descriptive names for foreign keys:

```rust
#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct Post {
    // ... other fields ...
    pub author_id: i64,  // Better than just user_id
    pub category_id: Option<i64>,  // Optional relationship
}
```

### Custom Types

Use type aliases for clarity:

```rust
pub type Timestamp = i64;
pub type Money = i64;  // Stored in cents

#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct Order {
    #[sqlx(default)]
    pub id: i64,
    pub amount: Money,
    pub processed_at: Option<Timestamp>,
    pub created_at: Timestamp,
    pub updated_at: Timestamp,
}
``` 