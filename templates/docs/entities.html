{% extends "docs_base.html" %}

{% block title %}Entities - Ruskit Documentation{% endblock %}

{% block content %}
<div class="prose prose-slate max-w-none">
    <h1>Entities</h1>

    <p>Entities in Ruskit represent the data structures of your application. They are the foundation of your models and define the shape of your database tables.</p>

    <h2 id="entity-structure">Entity Structure</h2>

    <p>An entity is a Rust struct that represents a database table. It defines:</p>
    <ul>
        <li>The fields and their types</li>
        <li>Validation rules through derive macros</li>
        <li>Serialization/deserialization behavior</li>
    </ul>

    <h2 id="auto-generated-entities">Auto-Generated Entities</h2>

    <p>Entities are automatically generated from your database schema after running migrations:</p>

    <pre><code class="language-bash">cargo kit migrate        # Run pending migrations and generate entities
cargo kit migrate:fresh # Drop all tables, re-run migrations, and generate entities</code></pre>

    <p>Each generated entity file includes:</p>
    <ul>
        <li>A warning header about auto-generation</li>
        <li>Instructions for regeneration</li>
        <li>Instructions for modifying the schema</li>
        <li>Table documentation</li>
        <li>Field-level documentation (primary keys, nullable fields)</li>
        <li>Proper type mappings based on the schema</li>
    </ul>

    <p>Example of a generated entity:</p>

    <pre><code class="language-rust">//! This file is auto-generated after running database migrations.
//! DO NOT EDIT THIS FILE MANUALLY.
//! 
//! To regenerate this file, run:
//! ```bash
//! cargo kit migrate
//! ```
//! 
//! To modify the schema, create a new migration:
//! ```bash
//! cargo kit make:migration add_field_to_users --model User
//! ```
//! 
//! Then edit the migration file and run:
//! ```bash
//! cargo kit migrate
//! ```

use crate::framework::prelude::*;

/// Represents a record in the `users` table.
/// This struct is automatically generated from the database schema.
#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct User {
    /// Primary key of the record
    #[sqlx(default)]
    pub id: i64,
    pub name: String,
    pub email: String,
    pub created_at: i64,
    pub updated_at: i64,
}</code></pre>

    <h2 id="type-mappings">Type Mappings</h2>

    <p>The entity generator automatically maps SQLite types to Rust types:</p>

    <table>
        <thead>
            <tr>
                <th>SQLite Type</th>
                <th>Rust Type</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>INTEGER</td>
                <td>i64</td>
                <td>Used for IDs, timestamps, and numeric fields</td>
            </tr>
            <tr>
                <td>REAL</td>
                <td>f64</td>
                <td>For floating-point numbers</td>
            </tr>
            <tr>
                <td>TEXT</td>
                <td>String</td>
                <td>For text fields</td>
            </tr>
            <tr>
                <td>BOOLEAN</td>
                <td>bool</td>
                <td>For boolean values</td>
            </tr>
            <tr>
                <td>*</td>
                <td>String</td>
                <td>Default fallback for unknown types</td>
            </tr>
        </tbody>
    </table>

    <p>Nullable fields are automatically wrapped in <code>Option&lt;T&gt;</code> unless they are primary keys.</p>

    <h2 id="best-practices">Best Practices</h2>

    <ol>
        <li><strong>Schema Changes</strong>:
            <ul>
                <li>Never edit entity files directly</li>
                <li>Always create migrations for schema changes</li>
                <li>Run <code>cargo kit migrate</code> to regenerate entities</li>
            </ul>
        </li>
        <li><strong>Field Types</strong>:
            <ul>
                <li>Primary keys are always non-nullable</li>
                <li>Use appropriate SQLite types in migrations</li>
                <li>Consider using TEXT for UUIDs or large numbers</li>
            </ul>
        </li>
        <li><strong>Organization</strong>:
            <ul>
                <li>Entities are stored in <code>src/app/entities/</code></li>
                <li>One entity per file</li>
                <li>Automatically exported through <code>mod.rs</code></li>
            </ul>
        </li>
        <li><strong>Documentation</strong>:
            <ul>
                <li>Generated documentation explains the table structure</li>
                <li>Field documentation indicates constraints</li>
                <li>Comments show how to modify the schema</li>
            </ul>
        </li>
    </ol>

    <h2 id="common-patterns">Common Patterns</h2>

    <h3>Creating New Tables</h3>

    <ol>
        <li>Create a new migration:
            <pre><code class="language-bash">cargo kit make:migration create_orders_table --model Order</code></pre>
        </li>
        <li>Edit the migration file to define your schema</li>
        <li>Run migrations to generate the entity:
            <pre><code class="language-bash">cargo kit migrate</code></pre>
        </li>
    </ol>

    <h3>Adding Fields</h3>

    <ol>
        <li>Create a modification migration:
            <pre><code class="language-bash">cargo kit make:migration add_status_to_orders --model Order</code></pre>
        </li>
        <li>Edit the migration file to add your field</li>
        <li>Run migrations to update the entity:
            <pre><code class="language-bash">cargo kit migrate</code></pre>
        </li>
    </ol>

    <h3>Relationships</h3>

    <p>Use descriptive foreign key names in your migrations:</p>

    <pre><code class="language-sql">CREATE TABLE posts (
    id INTEGER PRIMARY KEY,
    author_id INTEGER NOT NULL,  -- Better than just user_id
    category_id INTEGER,         -- Optional relationship
    FOREIGN KEY (author_id) REFERENCES users(id),
    FOREIGN KEY (category_id) REFERENCES categories(id)
);</code></pre>

    <p>The entity generator will preserve these relationships in the generated code.</p>

    <h2 id="derive-macros">Derive Macros</h2>

    <p>Entities use several important derive macros:</p>

    <ol>
        <li><code>#[derive(Debug, Serialize, Deserialize)]</code>
            <ul>
                <li>Enables debugging and JSON serialization/deserialization</li>
                <li>Required for API responses and database operations</li>
            </ul>
        </li>
        <li><code>#[derive(FromRow)]</code>
            <ul>
                <li>Allows SQLx to map database rows to your entity</li>
                <li>Automatically converts database types to Rust types</li>
            </ul>
        </li>
        <li><code>#[derive(GenerateValidationFields)]</code>
            <ul>
                <li>Generates validation field definitions</li>
                <li>Creates the necessary trait implementations for validation</li>
                <li>Works in conjunction with the <code>ValidationRules</code> trait in your model</li>
            </ul>
        </li>
    </ol>

    <h2 id="field-attributes">Field Attributes</h2>

    <h3>SQLx Attributes</h3>

    <ul>
        <li><code>#[sqlx(default)]</code>: Use default value if field is NULL</li>
        <li><code>#[sqlx(rename = "column_name")]</code>: Map to different column name</li>
        <li><code>#[sqlx(type_name = "custom_type")]</code>: Specify custom SQL type</li>
    </ul>

    <h3>Validation Attributes</h3>

    <p>Validation is handled at the model level through the <code>ValidationRules</code> trait. The entity's <code>GenerateValidationFields</code> derive macro generates the necessary field definitions.</p>

    <h2 id="example-entities">Example Entities</h2>

    <h3>Basic Entity</h3>

    <pre><code class="language-rust">#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct Post {
    #[sqlx(default)]
    pub id: i64,
    pub title: String,
    pub content: String,
    pub published: bool,
    pub created_at: i64,
    pub updated_at: i64,
}</code></pre>

    <h3>Entity with Relationships</h3>

    <pre><code class="language-rust">#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct Comment {
    #[sqlx(default)]
    pub id: i64,
    pub post_id: i64,  // Foreign key to posts table
    pub user_id: i64,  // Foreign key to users table
    pub content: String,
    pub created_at: i64,
    pub updated_at: i64,
}</code></pre>

    <h3>Entity with Optional Fields</h3>

    <pre><code class="language-rust">#[derive(Debug, Serialize, Deserialize, FromRow, GenerateValidationFields)]
pub struct Profile {
    #[sqlx(default)]
    pub id: i64,
    pub user_id: i64,
    pub bio: Option&lt;String&gt;,
    pub website: Option&lt;String&gt;,
    pub avatar_url: Option&lt;String&gt;,
    pub created_at: i64,
    pub updated_at: i64,
}</code></pre>
</div>

<div class="mt-8 border-t border-gray-200 pt-6">
    <div class="flex justify-between">
        <a href="/docs/models" class="text-primary-600 hover:text-primary-900">← Models</a>
        <a href="/docs/validation" class="text-primary-600 hover:text-primary-900">Validation →</a>
    </div>
</div>
{% endblock %}

{% block toc %}
<div class="hidden xl:block">
    <div class="sticky top-16 space-y-4">
        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <h4 class="text-sm font-medium text-gray-900 mb-4">On this page</h4>
            <nav class="space-y-2">
                <a href="#entity-structure" class="block text-gray-500 hover:text-gray-900 text-sm">Entity Structure</a>
                <a href="#auto-generated-entities" class="block text-gray-500 hover:text-gray-900 text-sm">Auto-Generated Entities</a>
                <a href="#type-mappings" class="block text-gray-500 hover:text-gray-900 text-sm">Type Mappings</a>
                <a href="#best-practices" class="block text-gray-500 hover:text-gray-900 text-sm">Best Practices</a>
                <a href="#common-patterns" class="block text-gray-500 hover:text-gray-900 text-sm">Common Patterns</a>
                <a href="#derive-macros" class="block text-gray-500 hover:text-gray-900 text-sm">Derive Macros</a>
                <a href="#field-attributes" class="block text-gray-500 hover:text-gray-900 text-sm">Field Attributes</a>
                <a href="#example-entities" class="block text-gray-500 hover:text-gray-900 text-sm">Example Entities</a>
            </nav>
        </div>
    </div>
</div>
{% endblock %} 