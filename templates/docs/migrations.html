{% extends "docs_base.html" %}

{% block title %}Database Migrations - Ruskit Documentation{% endblock %}

{% block content %}
<div class="prose prose-slate max-w-none">
    <h1>Database Migrations</h1>

    <p>Database migrations in Ruskit allow you to evolve your database schema over time. Each migration represents a set of changes to your database structure.</p>

    <h2 id="migration-commands">Migration Commands</h2>

    <ul>
        <li><code>cargo kit migrate</code> - Run pending migrations and generate entities</li>
        <li><code>cargo kit migrate:fresh</code> - Drop all tables, re-run migrations, and generate entities</li>
        <li><code>cargo kit make:migration</code> - Create a new migration file</li>
    </ul>

    <h2 id="creating-migrations">Creating Migrations</h2>

    <h3>New Table Migration</h3>

    <pre><code class="language-bash">cargo kit make:migration create_users_table --model User</code></pre>

    <p>This creates a new migration file in <code>database/migrations/</code> with a timestamp prefix.</p>

    <h3>Adding Fields</h3>

    <pre><code class="language-bash">cargo kit make:migration add_status_to_users --model User</code></pre>

    <h2 id="migration-structure">Migration Structure</h2>

    <p>Each migration file contains an <code>up</code> and <code>down</code> function:</p>

    <pre><code class="language-rust">use ruskit::framework::database::migration::Migration;
use ruskit::framework::database::DatabaseError;
use sqlx::{Pool, Sqlite};

pub struct CreateUsersTable;

#[async_trait::async_trait]
impl Migration for CreateUsersTable {
    async fn up(&self, pool: &Pool<Sqlite>) -> Result<(), DatabaseError> {
        sqlx::query(
            "CREATE TABLE users (
                id INTEGER PRIMARY KEY,
                name TEXT NOT NULL,
                email TEXT NOT NULL,
                created_at INTEGER NOT NULL,
                updated_at INTEGER NOT NULL
            )"
        )
        .execute(pool)
        .await?;
        
        Ok(())
    }

    async fn down(&self, pool: &Pool<Sqlite>) -> Result<(), DatabaseError> {
        sqlx::query("DROP TABLE users")
            .execute(pool)
            .await?;
            
        Ok(())
    }
}</code></pre>

    <h2 id="auto-generation-process">Auto-Generation Process</h2>

    <p>When you run migrations, Ruskit:</p>

    <ol>
        <li>Executes pending migrations</li>
        <li>Inspects the database schema</li>
        <li>Generates entity files based on the schema</li>
        <li>Updates the entities module exports</li>
    </ol>

    <p>The generated entities include:</p>
    <ul>
        <li>Documentation about auto-generation</li>
        <li>Instructions for regeneration</li>
        <li>Field-level documentation</li>
        <li>Proper type mappings</li>
    </ul>

    <h2 id="best-practices">Best Practices</h2>

    <ol>
        <li><strong>Migration Names</strong>:
            <ul>
                <li>Use descriptive names (<code>create_users_table</code>)</li>
                <li>Include model name for context</li>
                <li>Use snake_case</li>
            </ul>
        </li>
        <li><strong>Schema Design</strong>:
            <ul>
                <li>Always include <code>id</code>, <code>created_at</code>, <code>updated_at</code></li>
                <li>Use appropriate SQLite types</li>
                <li>Consider indexing for performance</li>
                <li>Define foreign key constraints</li>
            </ul>
        </li>
        <li><strong>Running Migrations</strong>:
            <ul>
                <li>Test migrations locally first</li>
                <li>Back up production data</li>
                <li>Run <code>migrate:fresh</code> in development</li>
                <li>Use <code>migrate</code> in production</li>
            </ul>
        </li>
        <li><strong>Entity Generation</strong>:
            <ul>
                <li>Never edit generated entities</li>
                <li>Create new migrations for changes</li>
                <li>Review generated entities after migration</li>
            </ul>
        </li>
    </ol>

    <h2 id="common-patterns">Common Patterns</h2>

    <h3>Primary Keys</h3>

    <pre><code class="language-sql">CREATE TABLE users (
    id INTEGER PRIMARY KEY,  -- Auto-incrementing primary key
    -- other fields
);</code></pre>

    <h3>Timestamps</h3>

    <pre><code class="language-sql">CREATE TABLE posts (
    -- other fields
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
);</code></pre>

    <h3>Foreign Keys</h3>

    <pre><code class="language-sql">CREATE TABLE comments (
    id INTEGER PRIMARY KEY,
    post_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    FOREIGN KEY (post_id) REFERENCES posts(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);</code></pre>

    <h3>Nullable Fields</h3>

    <pre><code class="language-sql">CREATE TABLE profiles (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    bio TEXT,  -- Nullable
    website TEXT,  -- Nullable
    FOREIGN KEY (user_id) REFERENCES users(id)
);</code></pre>

    <h3>Unique Constraints</h3>

    <pre><code class="language-sql">CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    email TEXT NOT NULL UNIQUE,
    -- other fields
);</code></pre>

    <h2 id="troubleshooting">Troubleshooting</h2>

    <p>If entity generation fails:</p>

    <ol>
        <li>Check migration syntax</li>
        <li>Verify foreign key constraints</li>
        <li>Run <code>migrate:fresh</code> to start clean</li>
        <li>Check database connection</li>
        <li>Review migration logs</li>
    </ol>
</div>

<div class="mt-8 border-t border-gray-200 pt-6">
    <div class="flex justify-between">
        <a href="/docs/models" class="text-primary-600 hover:text-primary-900">← Models</a>
        <a href="/docs/entities" class="text-primary-600 hover:text-primary-900">Entities →</a>
    </div>
</div>
{% endblock %}

{% block toc %}
<div class="hidden xl:block">
    <div class="sticky top-16 space-y-4">
        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <h4 class="text-sm font-medium text-gray-900 mb-4">On this page</h4>
            <nav class="space-y-2">
                <a href="#migration-commands" class="block text-gray-500 hover:text-gray-900 text-sm">Migration Commands</a>
                <a href="#creating-migrations" class="block text-gray-500 hover:text-gray-900 text-sm">Creating Migrations</a>
                <a href="#migration-structure" class="block text-gray-500 hover:text-gray-900 text-sm">Migration Structure</a>
                <a href="#auto-generation-process" class="block text-gray-500 hover:text-gray-900 text-sm">Auto-Generation Process</a>
                <a href="#best-practices" class="block text-gray-500 hover:text-gray-900 text-sm">Best Practices</a>
                <a href="#common-patterns" class="block text-gray-500 hover:text-gray-900 text-sm">Common Patterns</a>
                <a href="#troubleshooting" class="block text-gray-500 hover:text-gray-900 text-sm">Troubleshooting</a>
            </nav>
        </div>
    </div>
</div>
{% endblock %} 